<div class="dashboard-container">
  <mat-toolbar color="primary">
    <span>Environmental Monitoring Dashboard</span>
    <span class="spacer"></span>
    <button mat-icon-button (click)="manualRefresh()" [disabled]="loading">
      <mat-icon>refresh</mat-icon>
    </button>
    <span class="last-updated">Last updated: {{ lastUpdated | date:'short' }}</span>
  </mat-toolbar>

  <div class="dashboard-content" *ngIf="!loading && dashboardData">
    <div class="dashboard-grid">
      
      <!-- Weather Data Section -->
      <mat-card class="data-card">
        <mat-card-header>
          <mat-card-title>Weather Conditions</mat-card-title>
          <mat-card-subtitle>Recent weather data from api.weather.gov</mat-card-subtitle>
          <button mat-icon-button (click)="refreshDataSource('weather')">
            <mat-icon>refresh</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="weather-grid">
            <div *ngFor="let weather of dashboardData.recentWeatherData.slice(0, 4)" class="weather-item">
              <h4>{{ weather.stationId }}</h4>
              <p><strong>{{ weather.temperature | number:'1.1-1' }}°F</strong></p>
              <p>{{ weather.weatherConditions }}</p>
              <p>Humidity: {{ weather.humidity | number:'1.0-0' }}%</p>
              <p>Wind: {{ weather.windSpeed | number:'1.0-0' }} mph</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Meteo Data Section -->
      <mat-card class="data-card">
        <mat-card-header>
          <mat-card-title>Open-Meteo Data</mat-card-title>
          <mat-card-subtitle>Weather data from Open-Meteo API</mat-card-subtitle>
          <button mat-icon-button (click)="refreshDataSource('meteo')">
            <mat-icon>refresh</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="meteo-grid">
            <div *ngFor="let meteo of dashboardData.recentMeteoData.slice(0, 4)" class="meteo-item">
              <h4>{{ meteo.latitude }}, {{ meteo.longitude }}</h4>
              <p><strong>{{ meteo.temperature2m | number:'1.1-1' }}°F</strong></p>
              <p>UV Index: {{ meteo.uvIndex | number:'1.1-1' }}</p>
              <p>Precipitation: {{ meteo.precipitation | number:'1.1-1' }} mm</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Marine Data Section -->
      <mat-card class="data-card">
        <mat-card-header>
          <mat-card-title>Marine Conditions</mat-card-title>
          <mat-card-subtitle>Tidal and wave information</mat-card-subtitle>
          <button mat-icon-button (click)="refreshDataSource('marine')">
            <mat-icon>refresh</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="marine-grid">
            <div *ngFor="let marine of dashboardData.recentMarineData.slice(0, 4)" class="marine-item">
              <h4>Station {{ marine.stationId }}</h4>
              <p>Water Level: {{ marine.waterLevel | number:'1.2-2' }} ft</p>
              <p>Wave Height: {{ marine.waveHeight | number:'1.1-1' }} ft</p>
              <p>Water Temp: {{ marine.waterTemperature | number:'1.1-1' }}°F</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Air Quality Section -->
      <mat-card class="data-card">
        <mat-card-header>
          <mat-card-title>Air Quality</mat-card-title>
          <mat-card-subtitle>Particulate monitoring data</mat-card-subtitle>
          <button mat-icon-button (click)="refreshDataSource('airquality')">
            <mat-icon>refresh</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="air-quality-grid">
            <div *ngFor="let air of dashboardData.recentAirQualityData.slice(0, 4)" class="air-quality-item">
              <h4>{{ air.stationId }}</h4>
              <p>AQI: <strong [class]="getAqiClass(air.aqi)">{{ air.aqi }}</strong></p>
              <p>PM2.5: {{ air.pm25 | number:'1.1-1' }} μg/m³</p>
              <p>PM10: {{ air.pm10 | number:'1.1-1' }} μg/m³</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Fire Data Section -->
      <mat-card class="data-card">
        <mat-card-header>
          <mat-card-title>Forest Fires</mat-card-title>
          <mat-card-subtitle>Active fire information</mat-card-subtitle>
          <button mat-icon-button (click)="refreshDataSource('fire')">
            <mat-icon>refresh</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="fire-grid">
            <div *ngFor="let fire of dashboardData.recentFireData.slice(0, 4)" class="fire-item">
              <h4>{{ fire.name }}</h4>
              <p>Status: <span [class]="getFireStatusClass(fire.fireStatus)">{{ fire.fireStatus }}</span></p>
              <p>Size: {{ fire.fireSizeAcres | number:'1.0-0' }} acres</p>
              <p>Cause: {{ fire.fireCause }}</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Webcams Section -->
      <mat-card class="data-card">
        <mat-card-header>
          <mat-card-title>Live Webcams</mat-card-title>
          <mat-card-subtitle>Available public webcam feeds</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="webcam-grid">
            <div *ngFor="let webcam of dashboardData.activeWebcams.slice(0, 6)" class="webcam-item">
              <h4>{{ webcam.name }}</h4>
              <p>{{ webcam.location }}</p>
              <p>Category: {{ webcam.category }}</p>
              <button mat-button color="primary" (click)="openWebcam(webcam.url)">View</button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- System Status Section -->
      <mat-card class="data-card full-width">
        <mat-card-header>
          <mat-card-title>Data Source Status</mat-card-title>
          <mat-card-subtitle>System monitoring and health</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="status-grid">
            <div *ngFor="let status of dashboardData.dataSourceStatuses" class="status-item">
              <h4>{{ status.sourceName }}</h4>
              <p>Status: <mat-icon [class]="status.isActive ? 'status-active' : 'status-inactive'">
                {{ status.isActive ? 'check_circle' : 'error' }}
              </mat-icon></p>
              <p>Last Success: {{ status.lastSuccessfulFetch | date:'short' }}</p>
              <p>Fetch Count: {{ status.fetchCount }}</p>
              <p>Error Count: {{ status.errorCount }}</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Loading dashboard data...</p>
  </div>

  <!-- Error Message -->
  <div class="error-container" *ngIf="error && !loading">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadDashboardData()">Retry</button>
  </div>

</div>
